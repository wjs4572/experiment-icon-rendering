<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Past Test Results - Icon Performance Testing</title>
    <link rel="icon" href="https://simpsonconcepts.com/img/favicon_io/favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Internationalization System -->
    <script src="js/i18n.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-8 py-12">
        <!-- Language Selector -->
        <div class="text-right mb-4">
            <select id="languageSelector" class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="en">English</option>
                <option value="en-us">English (United States)</option>
                <option value="en-gb">English (United Kingdom)</option>
                <option value="es">Espa√±ol</option>
                <option value="fr">Fran√ßais</option>
                <option value="de">Deutsch</option>
                <option value="ja">Êó•Êú¨Ë™û</option>
                <option value="zh">‰∏≠Êñá</option>
                <option value="zh-tw">‰∏≠Êñá (ÁπÅÈ´î)</option>
                <option value="pt">Portugu√™s</option>
                <option value="pt-br">Portugu√™s (Brasil)</option>
                <option value="pt-pt">Portugu√™s (Portugal)</option>
            </select>
        </div>
        
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 mb-4" data-i18n="past.title">Past Test Results Archive</h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto" data-i18n="past.subtitle">
                Complete historical record of icon performance tests with full reproducibility data.
            </p>
            
            <!-- Browser-specific notice -->
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-300 rounded-lg text-sm max-w-4xl mx-auto">
                <div class="flex items-center justify-center">
                    <span class="mr-2 text-yellow-600">üåê</span>
                    <div>
                        <strong class="text-yellow-800" data-i18n="past.browser_notice">Browser-Specific Archives:</strong>
                        <span class="text-yellow-700 ml-1" data-i18n="past.browser_notice_desc">Each archived result includes browser identification and is specific to its execution environment</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 space-x-4">
                <a href="summary.html" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    ‚Üê Back to Summary
                </a>
                <a href="css.html" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    Run New Test
                </a>
                <button id="clearHistory" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors" data-i18n="past.clear_history">
                    Clear History
                </button>
                <button id="exportHistory" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" data-i18n="past.export_history">
                    Export All Results
                </button>
                <button id="importHistory" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors" data-i18n="past.import_results">
                    üìÇ Import Results
                </button>
                <button id="loadExample" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition-colors" data-i18n="past.load_example">
                    üìã Load Example
                </button>
                <input type="file" id="importFileInput" accept=".json" class="hidden" aria-label="Import JSON results file">
            </div>
            
            <!-- System Specifications Info -->
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm">
                <div class="flex items-start">
                    <span class="mr-2 text-blue-600">üìã</span>
                    <div>
                        <strong class="text-blue-800" data-i18n="past.system_specs_title">System Specifications for Reproducibility:</strong>
                        <span class="text-blue-700 ml-1" data-i18n="past.system_specs_desc">
                            Test results now include comprehensive system information in exports.
                        </span>
                        <div class="text-xs text-blue-600 mt-1" data-i18n="past.system_specs_note">
                            Configure system specs in the main testing interface to ensure your exported results include hardware details for scientific reproducibility.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Future CLI multi-browser testing note -->
            <div class="mt-4 p-3 bg-purple-50 border border-purple-200 rounded-lg text-sm">
                <div class="flex items-start">
                    <span class="mr-2 text-purple-600">üõ†</span>
                    <div>
                        <strong class="text-purple-800">Future Development:</strong>
                        <span class="text-purple-700 ml-1">
                            A future project version may provide CLI tools for automated multi-browser testing and comparison. 
                            The current version focuses on accurate, reproducible results within individual browser environments.
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Import Status Message -->
        <div id="importStatus" class="hidden mb-6 p-4 rounded-lg text-center"></div>

        <!-- Filter Controls -->
        <div class="bg-white p-6 rounded-lg shadow mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold" data-i18n="past.filter_title">Filter Results</h2>
                <div class="flex items-center gap-3">
                    <span id="filterResultCount" class="text-sm text-gray-500"></span>
                    <button id="clearFilters" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors hidden" data-i18n="past.clear_filters">
                        Clear Filters
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="filterTestType" data-i18n="past.filter.test_type">Test Type:</label>
                    <select id="filterTestType" class="w-full p-2 border rounded text-sm">
                        <option value="" data-i18n="past.filter.all_types">All Types</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="filterDate" data-i18n="past.filter.date_range">Date Range:</label>
                    <select id="filterDate" class="w-full p-2 border rounded text-sm">
                        <option value="" data-i18n="past.filter.all_time">All Time</option>
                        <option value="today" data-i18n="past.filter.today">Today</option>
                        <option value="week" data-i18n="past.filter.week">Past Week</option>
                        <option value="month" data-i18n="past.filter.month">Past Month</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="filterSignificance" data-i18n="past.filter.significance">Significance:</label>
                    <select id="filterSignificance" class="w-full p-2 border rounded text-sm">
                        <option value="" data-i18n="past.filter.all_results">All Results</option>
                        <option value="significant" data-i18n="past.filter.significant">Significant Only</option>
                        <option value="not-significant" data-i18n="past.filter.not_significant">Not Significant Only</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="filterOriginalSource" data-i18n="past.filter.original_source">Original Source:</label>
                    <select id="filterOriginalSource" class="w-full p-2 border rounded text-sm">
                        <option value="" data-i18n="past.filter.all_sources">All Sources</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="filterInputSource" data-i18n="past.filter.input_source">Input Source:</label>
                    <select id="filterInputSource" class="w-full p-2 border rounded text-sm">
                        <option value="" data-i18n="past.filter.all_inputs">All Inputs</option>
                        <option value="Current Data" data-i18n="past.filter.current_data">Current Data (Live Tests)</option>
                        <option value="file" data-i18n="past.filter.imported_file">Imported File</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" for="filterFileName" data-i18n="past.filter.file_name">File Name:</label>
                    <select id="filterFileName" class="w-full p-2 border rounded text-sm">
                        <option value="" data-i18n="past.filter.all_files">All Files</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button id="applyFilters" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm" data-i18n="past.apply_filters">
                    Apply Filters
                </button>
            </div>
        </div>

        <!-- Results Summary -->
        <div id="resultsSummary" class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-semibold mb-4" data-i18n="past.summary_title">Test History Summary</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="p-4 bg-blue-50 rounded">
                    <div class="text-2xl font-bold text-blue-600" id="totalTests">0</div>
                    <div class="text-sm text-gray-600" data-i18n="past.total_tests">Total Tests</div>
                </div>
                <div class="p-4 bg-green-50 rounded">
                    <div class="text-2xl font-bold text-green-600" id="significantTests">0</div>
                    <div class="text-sm text-gray-600" data-i18n="past.significant_tests">Significant Results</div>
                </div>
                <div class="p-4 bg-purple-50 rounded">
                    <div class="text-2xl font-bold text-purple-600" id="totalIterations">0</div>
                    <div class="text-sm text-gray-600" data-i18n="past.total_iterations">Total Iterations</div>
                </div>
                <div class="p-4 bg-yellow-50 rounded">
                    <div class="text-2xl font-bold text-yellow-600" id="totalTestTime">0h 0m</div>
                    <div class="text-sm text-gray-600" data-i18n="past.total_test_time">Total Test Time</div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div id="testResults" class="space-y-8">
            <!-- Test results will be populated here -->
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="text-center py-12 hidden">
            <div class="text-gray-500 text-lg">No test results found.</div>
            <div class="mt-4">
                <a href="css.html" class="text-blue-600 hover:text-blue-800 underline">Run your first performance test</a>
            </div>
        </div>
    </div>

    <script>
        class PastResultsManager {
            constructor() {
                this.pastResults = this.loadPastResults();
                this.init();
            }

            init() {
                this.filteredResults = null;
                this.setupEventListeners();
                this.populateAllFilters();
                this.restoreFilterState();
                this.displayResults();
                this.updateSummary();
                this.updateFilterUI();
            }

            getLocale() {
                return window.i18n?.currentLanguage || navigator.language || 'en';
            }

            formatDate(dateStr) {
                if (!dateStr) return 'N/A';
                const d = new Date(dateStr);
                return isNaN(d) ? 'N/A' : d.toLocaleString(this.getLocale());
            }

            formatNumber(num) {
                return typeof num === 'number' ? num.toLocaleString(this.getLocale()) : num;
            }

            t(key, fallback) {
                return window.i18n?.translate(key) || fallback || key;
            }

            setupEventListeners() {
                document.getElementById('clearHistory').addEventListener('click', () => this.clearHistory());
                document.getElementById('exportHistory').addEventListener('click', () => this.exportHistory());
                document.getElementById('importHistory').addEventListener('click', () => this.triggerImport());
                document.getElementById('importFileInput').addEventListener('change', (e) => this.handleImportFile(e));
                document.getElementById('loadExample').addEventListener('click', () => this.loadExample());
                document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
                document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());

                // Auto-apply filters on any dropdown change
                const filterIds = ['filterTestType', 'filterDate', 'filterSignificance', 'filterOriginalSource', 'filterInputSource', 'filterFileName'];
                filterIds.forEach(id => {
                    document.getElementById(id).addEventListener('change', () => this.applyFilters());
                });
            }

            loadPastResults() {
                try {
                    const results = localStorage.getItem('iconTestHistory');
                    return results ? JSON.parse(results) : [];
                } catch (error) {
                    console.error('Error loading past results:', error);
                    return [];
                }
            }

            savePastResults() {
                try {
                    localStorage.setItem('iconTestHistory', JSON.stringify(this.pastResults));
                } catch (error) {
                    console.error('Error saving past results:', error);
                }
            }

            addResult(testResult) {
                // Add comprehensive test result to history
                const historyEntry = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    testDate: testResult.testDate,
                    
                    // Test Configuration - Critical for reproducibility
                    testConfiguration: {
                        testType: testResult.testType || 'unknown',
                        testTypeDescription: this.getTestTypeDescription(testResult.testType),
                        iterations: testResult.iterations,
                        testDuration: testResult.testDuration,
                        iterationsPerSecond: testResult.iterationsPerSecond || (testResult.iterations / testResult.testDuration),
                        method: testResult.method || 'straight' // batched vs straight
                    },

                    // System Environment - For reproducibility
                    systemInfo: {
                        userAgent: testResult.testMetadata?.userAgent || navigator.userAgent,
                        timestamp: testResult.testMetadata?.timestamp || performance.now(),
                        screenResolution: `${screen.width}x${screen.height}`,
                        colorDepth: screen.colorDepth,
                        platform: navigator.platform,
                        memory: performance.memory ? {
                            jsHeapSizeLimit: performance.memory.jsHeapSizeLimit,
                            totalJSHeapSize: performance.memory.totalJSHeapSize,
                            usedJSHeapSize: performance.memory.usedJSHeapSize
                        } : null
                    },

                    // Complete Performance Results
                    results: testResult.results,
                    
                    // Statistical Analysis
                    statisticalAnalysis: testResult.statisticalAnalysis || {},
                    performanceRanking: testResult.performanceRanking || [],
                    
                    // Summary Statistics
                    summary: {
                        fastestIconType: this.getFastestIcon(testResult.performanceRanking),
                        slowestIconType: this.getSlowestIcon(testResult.performanceRanking),
                        significantDifferences: this.getSignificantCount(testResult.statisticalAnalysis),
                        averageRenderTime: this.getAverageRenderTime(testResult.results),
                        performanceSpread: this.getPerformanceSpread(testResult.performanceRanking)
                    },

                    // Source tracking for provenance
                    sourceInfo: {
                        originalSource: this.inferOriginalSource(testResult.results),
                        fileName: 'Current Data',
                        importedAt: null
                    }
                };

                this.pastResults.unshift(historyEntry); // Add to beginning
                this.savePastResults();
                return historyEntry.id;
            }

            getTestTypeDescription(testType) {
                const descriptions = {
                    'css': 'CSS Test (legacy)',
                    'single': 'Single Icon Test (2,000 iterations)',
                    'bulk': 'Bulk Icon Test (100 icons √ó 50 iterations)',
                    'stress': 'Stress Test (500 icons √ó 200 iterations)',
                    'statistical': 'Statistical Power Test (100 icons √ó 200 iterations)',
                    'massive': 'Maximum Power Test (100 icons √ó 1,000 iterations)',
                    'ultra': 'Ultra Power Test (100 icons √ó 10,000 iterations)',
                    'extreme': 'Extreme Power Test (100 icons √ó 20,000 iterations)'
                };
                return descriptions[testType] || 'Unknown Test Type';
            }

            getFastestIcon(ranking) {
                return ranking && ranking.length > 0 ? ranking[0].iconType : 'Unknown';
            }

            getSlowestIcon(ranking) {
                return ranking && ranking.length > 0 ? ranking[ranking.length - 1].iconType : 'Unknown';
            }

            getSignificantCount(analysis) {
                if (!analysis) return 0;
                return Object.values(analysis).filter(stat => stat.isSignificant).length;
            }

            getAverageRenderTime(results) {
                if (!results) return 0;
                const times = Object.values(results).map(r => r.renderTime?.average || 0);
                return times.reduce((a, b) => a + b, 0) / times.length;
            }

            getPerformanceSpread(ranking) {
                if (!ranking || ranking.length < 2) return 0;
                const fastest = ranking[0].averageTime;
                const slowest = ranking[ranking.length - 1].averageTime;
                return ((slowest - fastest) / fastest * 100);
            }

            inferOriginalSource(results) {
                if (!results || typeof results !== 'object') return 'unknown';
                const keys = Object.keys(results);
                if (keys.length === 0) return 'unknown';
                const firstKey = keys[0].toLowerCase();
                if (firstKey.includes('css'))   return 'css.html';
                if (firstKey.includes('svg'))   return 'svg.html';
                if (firstKey.includes('png'))   return 'png.html';
                if (firstKey.includes('gif'))   return 'gif.html';
                if (firstKey.includes('jpeg'))  return 'jpeg.html';
                if (firstKey.includes('webp'))  return 'webp.html';
                if (firstKey.includes('avif'))  return 'avif.html';
                return 'unknown';
            }

            ensureSourceInfo(entry) {
                if (!entry.sourceInfo) {
                    entry.sourceInfo = {
                        originalSource: this.inferOriginalSource(entry.results),
                        fileName: 'Current Data',
                        importedAt: null
                    };
                }
                return entry;
            }

            populateAllFilters() {
                this.populateTestTypeFilter();
                this.populateSourceFilters();
                this.populateFileNameFilter();
            }

            populateTestTypeFilter() {
                const select = document.getElementById('filterTestType');
                const current = select.value;
                const types = new Set();
                this.pastResults.forEach(r => {
                    const t = r.testConfiguration?.testType;
                    if (t) types.add(t);
                });
                while (select.options.length > 1) select.remove(1);
                // Canonical order, then any extras
                const order = ['single', 'bulk', 'stress', 'statistical', 'massive', 'ultra', 'extreme', 'css'];
                const descMap = {
                    'css': 'CSS Test (legacy)',
                    'single': 'Single Icon Tests',
                    'bulk': 'Bulk Icon Tests',
                    'stress': 'Stress Tests',
                    'statistical': 'Statistical Power Tests',
                    'massive': 'Maximum Power Tests',
                    'ultra': 'Ultra Power Tests',
                    'extreme': 'Extreme Power Tests'
                };
                const ordered = order.filter(t => types.has(t));
                types.forEach(t => { if (!ordered.includes(t)) ordered.push(t); });
                ordered.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = descMap[t] || t;
                    select.appendChild(opt);
                });
                select.value = current; // restore previous selection
            }

            populateSourceFilters() {
                const sourceSelect = document.getElementById('filterOriginalSource');
                const current = sourceSelect.value;
                const sources = new Set();
                this.pastResults.forEach(r => {
                    const src = r.sourceInfo?.originalSource || this.inferOriginalSource(r.results);
                    if (src && src !== 'unknown') sources.add(src);
                });
                while (sourceSelect.options.length > 1) sourceSelect.remove(1);
                Array.from(sources).sort().forEach(src => {
                    const opt = document.createElement('option');
                    opt.value = src;
                    opt.textContent = src;
                    sourceSelect.appendChild(opt);
                });
                sourceSelect.value = current;
            }

            populateFileNameFilter() {
                const select = document.getElementById('filterFileName');
                const current = select.value;
                const names = new Set();
                this.pastResults.forEach(r => {
                    const fn = r.sourceInfo?.fileName;
                    if (fn && fn !== 'Current Data') names.add(fn);
                });
                while (select.options.length > 1) select.remove(1);
                Array.from(names).sort().forEach(fn => {
                    const opt = document.createElement('option');
                    opt.value = fn;
                    opt.textContent = fn;
                    select.appendChild(opt);
                });
                select.value = current;
            }

            getDisplayResults() {
                return this.filteredResults !== null ? this.filteredResults : this.pastResults;
            }

            displayResults() {
                const container = document.getElementById('testResults');
                const noResults = document.getElementById('noResults');
                const displayList = this.getDisplayResults();
                
                if (displayList.length === 0) {
                    container.innerHTML = '';
                    noResults.classList.remove('hidden');
                    return;
                }

                noResults.classList.add('hidden');
                container.innerHTML = displayList.map(result => this.createResultCard(result)).join('');
            }

            createResultCard(result) {
                const date = this.formatDate(result.timestamp);
                const config = result.testConfiguration;
                const summary = result.summary;
                const source = result.sourceInfo || {};
                const originalSource = source.originalSource || this.inferOriginalSource(result.results);
                const fileName = source.fileName || this.t('past.card.current_data', 'Current Data');
                const importedAt = source.importedAt ? this.formatDate(source.importedAt) : 'N/A';
                const isImported = !!source.fileName;
                const sourceBadgeClass = isImported ? 'bg-indigo-100 text-indigo-800' : 'bg-green-100 text-green-800';
                
                return `
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-semibold">${config.testTypeDescription}</h3>
                                    <p class="text-blue-100 mt-1">${date}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold">${config.iterationsPerSecond.toLocaleString(this.getLocale(), {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div>
                                    <div class="text-blue-100 text-sm">${this.t('past.card.iterations_sec', 'iterations/sec')}</div>
                                </div>
                            </div>
                            <div class="mt-3 flex flex-wrap gap-2 text-xs">
                                <span class="px-2 py-1 rounded bg-white/20">üìÑ ${originalSource}</span>
                                <span class="px-2 py-1 rounded ${isImported ? 'bg-indigo-400/30' : 'bg-green-400/30'}">${isImported ? 'üìÇ' : '‚ö°'} ${fileName}</span>
                                <span class="px-2 py-1 rounded bg-white/20">üïí ${this.t('past.card.imported', 'Imported:')} ${importedAt}</span>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Test Configuration -->
                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-800 mb-3">${this.t('past.card.test_config', 'Test Configuration')}</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="font-medium text-gray-600">${this.t('past.card.total_iterations', 'Total Iterations')}</div>
                                        <div class="text-lg font-bold text-gray-800">${this.formatNumber(config.iterations)}</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="font-medium text-gray-600">${this.t('past.card.duration', 'Duration')}</div>
                                        <div class="text-lg font-bold text-gray-800">${config.testDuration.toLocaleString(this.getLocale(), {minimumFractionDigits: 1, maximumFractionDigits: 1})}s</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="font-medium text-gray-600">${this.t('past.card.method', 'Method')}</div>
                                        <div class="text-lg font-bold text-gray-800">${config.method === 'straight' ? this.t('past.card.method_straight', 'Straight') : this.t('past.card.method_batched', 'Batched')}</div>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="font-medium text-gray-600">${this.t('past.card.significant_results', 'Significant Results')}</div>
                                        <div class="text-lg font-bold ${summary.significantDifferences > 0 ? 'text-green-600' : 'text-gray-800'}">${summary.significantDifferences}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Results -->
                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-800 mb-3">${this.t('past.card.perf_summary', 'Performance Summary')}</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-green-50 border border-green-200 p-4 rounded">
                                        <div class="text-green-600 font-medium">üèÜ ${this.t('past.card.fastest', 'Fastest')}</div>
                                        <div class="text-lg font-bold text-gray-800">${summary.fastestIconType}</div>
                                    </div>
                                    <div class="bg-red-50 border border-red-200 p-4 rounded">
                                        <div class="text-red-600 font-medium">üêå ${this.t('past.card.slowest', 'Slowest')}</div>
                                        <div class="text-lg font-bold text-gray-800">${summary.slowestIconType}</div>
                                    </div>
                                    <div class="bg-blue-50 border border-blue-200 p-4 rounded">
                                        <div class="text-blue-600 font-medium">üìä ${this.t('summary.card.performance_spread', 'Performance Spread')}</div>
                                        <div class="text-lg font-bold text-gray-800">${summary.performanceSpread.toLocaleString(this.getLocale(), {minimumFractionDigits: 1, maximumFractionDigits: 1})}%</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Statistical Details -->
                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-800 mb-3">${this.t('past.card.stat_analysis', 'Statistical Analysis')}</h4>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="bg-gray-50 border-b">
                                                <th class="text-left p-2">${this.t('past.card.comparison', 'Comparison')}</th>
                                                <th class="text-center p-2">${this.t('past.card.p_value', 'P-Value')}</th>
                                                <th class="text-center p-2">${this.t('past.card.significance', 'Significance')}</th>
                                                <th class="text-center p-2">${this.t('past.card.power', 'Power')}</th>
                                                <th class="text-center p-2">${this.t('past.card.effect_size', 'Effect Size')}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(result.statisticalAnalysis).map(([comparison, stats]) => `
                                                <tr class="border-b">
                                                    <td class="p-2 font-medium">${comparison}</td>
                                                    <td class="p-2 text-center">${stats.pValue < 0.001 ? '<0.001' : stats.pValue.toLocaleString(this.getLocale(), {minimumFractionDigits: 3, maximumFractionDigits: 3})}</td>
                                                    <td class="p-2 text-center">
                                                        <span class="${stats.isSignificant ? 'text-green-600' : 'text-red-600'}">
                                                            ${stats.isSignificant ? '‚úì ' + this.t('past.card.significant', 'Significant') : '‚úó ' + this.t('past.card.not_significant', 'Not Significant')}
                                                        </span>
                                                    </td>
                                                    <td class="p-2 text-center">${stats.power.toLocaleString(this.getLocale(), {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                    <td class="p-2 text-center">${stats.effectSize.toLocaleString(this.getLocale(), {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- System Information -->
                            <details class="mb-4">
                                <summary class="font-semibold text-gray-800 cursor-pointer hover:text-blue-600">
                                    ${this.t('past.card.system_env', 'System Environment (Click to expand)')}
                                </summary>
                                <div class="mt-3 text-sm bg-gray-50 p-4 rounded">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <strong>${this.t('past.card.browser', 'Browser:')}</strong> ${this.getBrowserName(result.systemInfo.userAgent)}
                                        </div>
                                        <div>
                                            <strong>${this.t('past.card.platform', 'Platform:')}</strong> ${result.systemInfo.platform}
                                        </div>
                                        <div>
                                            <strong>${this.t('past.card.screen', 'Screen:')}</strong> ${result.systemInfo.screenResolution}
                                        </div>
                                        <div>
                                            <strong>${this.t('past.card.color_depth', 'Color Depth:')}</strong> ${result.systemInfo.colorDepth}-bit
                                        </div>
                                        ${result.systemInfo.memory ? `
                                            <div class="col-span-full">
                                                <strong>${this.t('past.card.memory', 'Memory:')}</strong> ${(result.systemInfo.memory.usedJSHeapSize / (1024*1024)).toLocaleString(this.getLocale(), {minimumFractionDigits: 1, maximumFractionDigits: 1})} ${this.t('past.card.mb_used', 'MB used')} / ${(result.systemInfo.memory.jsHeapSizeLimit / (1024*1024)).toLocaleString(this.getLocale(), {minimumFractionDigits: 1, maximumFractionDigits: 1})} ${this.t('past.card.mb_limit', 'MB limit')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </details>

                            <!-- Actions -->
                            <div class="flex space-x-2">
                                <button onclick="pastResultsManager.exportSingleResult('${result.id}')" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    ${this.t('past.card.export_result', 'Export This Result')}
                                </button>
                                <button onclick="pastResultsManager.deleteResult('${result.id}')" 
                                        class="px-4 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                                    ${this.t('past.card.delete', 'Delete')}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            getBrowserName(userAgent) {
                if (userAgent.includes('Chrome')) return 'Chrome';
                if (userAgent.includes('Firefox')) return 'Firefox';
                if (userAgent.includes('Safari')) return 'Safari';
                if (userAgent.includes('Edge')) return 'Edge';
                return 'Unknown Browser';
            }

            updateSummary() {
                const displayList = this.getDisplayResults();
                const totalTests = displayList.length;
                const significantTests = displayList.filter(r => r.summary.significantDifferences > 0).length;
                const totalIterations = displayList.reduce((sum, r) => sum + r.testConfiguration.iterations, 0);
                const totalTime = displayList.reduce((sum, r) => sum + r.testConfiguration.testDuration, 0);

                document.getElementById('totalTests').textContent = this.formatNumber(totalTests);
                document.getElementById('significantTests').textContent = this.formatNumber(significantTests);
                document.getElementById('totalIterations').textContent = this.formatNumber(totalIterations);
                
                const hours = Math.floor(totalTime / 3600);
                const minutes = Math.floor((totalTime % 3600) / 60);
                const hLabel = this.t('past.time.hours_short', 'h');
                const mLabel = this.t('past.time.minutes_short', 'm');
                document.getElementById('totalTestTime').textContent = `${hours}${hLabel} ${minutes}${mLabel}`;
            }

            clearHistory() {
                if (confirm(this.t('past.confirm_clear', 'Are you sure you want to clear all test history? This cannot be undone.'))) {
                    this.pastResults = [];
                    this.savePastResults();
                    this.displayResults();
                    this.updateSummary();
                }
            }

            deleteResult(id) {
                if (confirm(this.t('past.confirm_delete', 'Delete this test result?'))) {
                    this.pastResults = this.pastResults.filter(r => r.id !== id);
                    this.savePastResults();
                    this.displayResults();
                    this.updateSummary();
                }
            }

            exportHistory() {
                const dataStr = JSON.stringify(this.pastResults, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `icon-test-history-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }

            exportSingleResult(id) {
                const result = this.pastResults.find(r => r.id === id);
                if (result) {
                    const dataStr = JSON.stringify(result, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `icon-test-${result.id}.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                }
            }

            applyFilters() {
                const testTypeFilter = document.getElementById('filterTestType').value;
                const dateFilter = document.getElementById('filterDate').value;
                const significanceFilter = document.getElementById('filterSignificance').value;
                const originalSourceFilter = document.getElementById('filterOriginalSource').value;
                const inputSourceFilter = document.getElementById('filterInputSource').value;
                const fileNameFilter = document.getElementById('filterFileName').value;

                // Check if any filter is active
                const hasActiveFilter = testTypeFilter || dateFilter || significanceFilter || originalSourceFilter || inputSourceFilter || fileNameFilter;

                if (!hasActiveFilter) {
                    this.filteredResults = null;
                    this.displayResults();
                    this.updateSummary();
                    this.updateFilterUI();
                    this.saveFilterState();
                    return;
                }

                let filtered = [...this.pastResults];

                // Filter by test type
                if (testTypeFilter) {
                    filtered = filtered.filter(r => r.testConfiguration?.testType === testTypeFilter);
                }

                // Filter by date range
                if (dateFilter) {
                    const now = new Date();
                    let cutoff;
                    if (dateFilter === 'today') {
                        cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    } else if (dateFilter === 'week') {
                        cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    } else if (dateFilter === 'month') {
                        cutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    }
                    if (cutoff) {
                        filtered = filtered.filter(r => new Date(r.timestamp) >= cutoff);
                    }
                }

                // Filter by significance
                if (significanceFilter === 'significant') {
                    filtered = filtered.filter(r => r.summary?.significantDifferences > 0);
                } else if (significanceFilter === 'not-significant') {
                    filtered = filtered.filter(r => !r.summary?.significantDifferences || r.summary.significantDifferences === 0);
                }

                // Filter by original source (test page)
                if (originalSourceFilter) {
                    filtered = filtered.filter(r => {
                        const src = r.sourceInfo?.originalSource || this.inferOriginalSource(r.results);
                        return src === originalSourceFilter;
                    });
                }

                // Filter by input source (file import vs live test)
                if (inputSourceFilter === 'Current Data') {
                    filtered = filtered.filter(r => !r.sourceInfo?.fileName || r.sourceInfo.fileName === 'Current Data');
                } else if (inputSourceFilter === 'file') {
                    filtered = filtered.filter(r => r.sourceInfo?.fileName && r.sourceInfo.fileName !== 'Current Data');
                }

                // Filter by specific file name
                if (fileNameFilter) {
                    filtered = filtered.filter(r => r.sourceInfo?.fileName === fileNameFilter);
                }

                this.filteredResults = filtered;
                this.displayResults();
                this.updateSummary();
                this.updateFilterUI();
                this.saveFilterState();
            }

            clearFilters() {
                document.getElementById('filterTestType').value = '';
                document.getElementById('filterDate').value = '';
                document.getElementById('filterSignificance').value = '';
                document.getElementById('filterOriginalSource').value = '';
                document.getElementById('filterInputSource').value = '';
                document.getElementById('filterFileName').value = '';
                this.filteredResults = null;
                this.displayResults();
                this.updateSummary();
                this.updateFilterUI();
                this.saveFilterState();
            }

            saveFilterState() {
                const state = {
                    testType: document.getElementById('filterTestType').value,
                    dateRange: document.getElementById('filterDate').value,
                    significance: document.getElementById('filterSignificance').value,
                    originalSource: document.getElementById('filterOriginalSource').value,
                    inputSource: document.getElementById('filterInputSource').value,
                    fileName: document.getElementById('filterFileName').value
                };
                localStorage.setItem('iconTestFilters', JSON.stringify(state));
            }

            restoreFilterState() {
                try {
                    const raw = localStorage.getItem('iconTestFilters');
                    if (!raw) return;
                    const state = JSON.parse(raw);
                    if (state.testType) document.getElementById('filterTestType').value = state.testType;
                    if (state.dateRange) document.getElementById('filterDate').value = state.dateRange;
                    if (state.significance) document.getElementById('filterSignificance').value = state.significance;
                    if (state.originalSource) document.getElementById('filterOriginalSource').value = state.originalSource;
                    if (state.inputSource) document.getElementById('filterInputSource').value = state.inputSource;
                    if (state.fileName) document.getElementById('filterFileName').value = state.fileName;
                    // Apply the restored filters
                    this.applyFilters();
                } catch (e) {
                    console.error('Error restoring filter state:', e);
                }
            }

            updateFilterUI() {
                const hasFilter = this.filteredResults !== null;
                const clearBtn = document.getElementById('clearFilters');
                const countEl = document.getElementById('filterResultCount');

                if (hasFilter) {
                    clearBtn.classList.remove('hidden');
                    const showing = this.filteredResults.length;
                    const total = this.pastResults.length;
                    countEl.textContent = `Showing ${showing} of ${total} results`;
                } else {
                    clearBtn.classList.add('hidden');
                    const total = this.pastResults.length;
                    countEl.textContent = total > 0 ? `${total} results` : '';
                }
            }

            triggerImport() {
                document.getElementById('importFileInput').click();
            }

            async loadExample() {
                const btn = document.getElementById('loadExample');
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    const response = await fetch('data/icon-test-history-default-example.json');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const data = await response.json();
                    this.processImportedData(data, 'icon-test-history-default-example.json');
                } catch (error) {
                    console.error('Load example error:', error);
                    this.showImportStatus('error', this.t('past.load_example_error', 'Failed to load example data.'));
                } finally {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            handleImportFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.endsWith('.json')) {
                    this.showImportStatus('error', this.t('past.import_invalid_format', 'Please select a valid JSON file.'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.processImportedData(data, file.name);
                    } catch (error) {
                        console.error('Import parse error:', error);
                        this.showImportStatus('error', this.t('past.import_parse_error', 'Failed to parse JSON file. Please check the file format.'));
                    }
                };
                reader.onerror = () => {
                    this.showImportStatus('error', this.t('past.import_read_error', 'Failed to read the file.'));
                };
                reader.readAsText(file);

                // Reset file input so the same file can be re-imported
                event.target.value = '';
            }

            processImportedData(data, fileName) {
                let importedCount = 0;
                let skippedCount = 0;
                const existingIds = new Set(this.pastResults.map(r => r.id));
                const importTimestamp = new Date().toISOString();

                const stampSource = (entry) => {
                    if (!entry.sourceInfo) {
                        entry.sourceInfo = {
                            originalSource: this.inferOriginalSource(entry.results),
                            fileName: fileName,
                            importedAt: importTimestamp
                        };
                    } else {
                        // Preserve originalSource if already set, but stamp file/import info
                        entry.sourceInfo.fileName = entry.sourceInfo.fileName || fileName;
                        entry.sourceInfo.importedAt = entry.sourceInfo.importedAt || importTimestamp;
                        if (!entry.sourceInfo.originalSource || entry.sourceInfo.originalSource === 'unknown') {
                            entry.sourceInfo.originalSource = this.inferOriginalSource(entry.results);
                        }
                    }
                    return entry;
                };

                // Format 1: Array of history entries (from export)
                if (Array.isArray(data)) {
                    data.forEach(entry => {
                        if (this.isValidHistoryEntry(entry)) {
                            // Skip duplicates by ID
                            if (existingIds.has(entry.id)) {
                                skippedCount++;
                                return;
                            }
                            this.pastResults.push(stampSource(entry));
                            existingIds.add(entry.id);
                            importedCount++;
                        }
                    });
                }
                // Format 2: Single history entry object
                else if (typeof data === 'object' && data !== null && this.isValidHistoryEntry(data)) {
                    if (!existingIds.has(data.id)) {
                        this.pastResults.push(stampSource(data));
                        importedCount++;
                    } else {
                        skippedCount++;
                    }
                }

                if (importedCount > 0) {
                    // Sort by timestamp descending (newest first)
                    this.pastResults.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    this.filteredResults = null; // Reset filters
                    this.savePastResults();
                    this.populateAllFilters();
                    this.displayResults();
                    this.updateSummary();
                    this.updateFilterUI();

                    let msg = `${this.t('past.import_success', 'Import successful!')} ${importedCount} ${this.t('past.import_entries_loaded', 'entries imported')}`;
                    if (skippedCount > 0) {
                        msg += ` (${skippedCount} ${this.t('past.import_duplicates_skipped', 'duplicates skipped')})`;
                    }
                    msg += ` ‚Äî ${fileName}`;
                    this.showImportStatus('success', msg);
                } else if (skippedCount > 0) {
                    this.showImportStatus('info', `${this.t('past.import_all_duplicates', 'All entries already exist in history.')} (${skippedCount} ${this.t('past.import_duplicates_skipped', 'duplicates skipped')})`);
                } else {
                    this.showImportStatus('error', this.t('past.import_no_valid_data', 'No valid test results found in the file.'));
                }
            }

            isValidHistoryEntry(entry) {
                // Must have at minimum an id, testConfiguration, and results
                return entry &&
                    typeof entry === 'object' &&
                    entry.id &&
                    entry.testConfiguration &&
                    entry.results &&
                    typeof entry.results === 'object';
            }

            showImportStatus(type, message) {
                const statusEl = document.getElementById('importStatus');
                statusEl.classList.remove('hidden');

                const styles = {
                    success: 'bg-green-50 border border-green-200 text-green-800',
                    error: 'bg-red-50 border border-red-200 text-red-800',
                    info: 'bg-blue-50 border border-blue-200 text-blue-800'
                };
                statusEl.className = `mb-6 p-4 rounded-lg text-center ${styles[type] || styles.info}`;
                statusEl.textContent = message;

                // Auto-hide after 8 seconds
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 8000);
            }
        }

        // Initialize the past results manager
        let pastResultsManager;

        function initPastResults() {
            if (!pastResultsManager) {
                pastResultsManager = new PastResultsManager();
                
                // Check if there's a new result to add from the current test session
                const currentResult = localStorage.getItem('iconTestResults_css');
                if (currentResult) {
                    try {
                        const parsedResult = JSON.parse(currentResult);
                        const existingId = localStorage.getItem('lastSavedResultId');
                        
                        // Only add if this is a new result (different timestamp)
                        if (!existingId || existingId !== parsedResult.testMetadata?.timestamp?.toString()) {
                            pastResultsManager.addResult(parsedResult);
                            localStorage.setItem('lastSavedResultId', parsedResult.testMetadata?.timestamp?.toString());
                            pastResultsManager.displayResults();
                            pastResultsManager.updateSummary();
                        }
                    } catch (error) {
                        console.error('Error processing current test result:', error);
                    }
                }
            } else {
                // Re-render on language change
                pastResultsManager.displayResults();
                pastResultsManager.updateSummary();
            }
        }

        document.addEventListener('i18nReady', initPastResults);
        document.addEventListener('languageChanged', function() {
            if (pastResultsManager) {
                pastResultsManager.displayResults();
                pastResultsManager.updateSummary();
            }
        });

        // Fallback: if i18n was already ready before this listener was attached
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (!pastResultsManager) initPastResults();
            }, 500);
        });
    </script>
</body>
</html>